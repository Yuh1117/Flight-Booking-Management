{% extends "layouts/base.html" %} {% block content %}
<div class="container mt-5">
  <div class="card">{% include "layouts/find.html" %}</div>
  <div class="card p-4 shadow-sm d-none">
    <div class="row">
      <button
        class="btn bg-warning col-1 d-flex gap-2 align-items-center justify-content-center"
      >
        <i class="fa-solid fa-filter"></i>
        Filter
      </button>
    </div>

    <div class="row d-flex align-items-center justify-content-center">
      <div class="col-md-3 mb-3">
        <label for="ticketType" class="form-label fw-bold">Loại vé</label>
        <select class="form-select" id="ticketType" name="ticket_type">
          <option value="" selected>Tất cả</option>
          <option value="thuong_gia">Thương gia</option>
          <option value="pho_thong">Phổ thông</option>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label for="budgetRange" class="form-label fw-bold"
          >Ngân sách (VNĐ)</label
        >
        <input
          type="range"
          class="form-range"
          id="budgetRange"
          name="budget"
          min="0"
          max="20000000"
          step="100000"
          oninput="document.getElementById('budgetValue').innerText = this.value + ' VNĐ';"
        />
        <span id="budgetValue" class="text-muted">10,000,000 VNĐ</span>
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label fw-bold">Số điểm dừng</label>
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            name="stop"
            id="noStop"
            value="0"
          />
          <label class="form-check-label" for="noStop"
            >Chỉ chuyến bay thẳng</label
          >
        </div>
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            name="stop"
            id="anyStop"
            value="1"
          />
          <label class="form-check-label" for="anyStop">Tất cả</label>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <button class="btn btn-primary">Apply</button>
      </div>
    </div>
  </div>
  {% if flights %}
    <div class="row m-3">
      <div
        class="d-flex justify-content-between align-items-center border-bottom pb-2"
      >
        <!-- Điểm đi và đến -->
        <div class="d-flex align-items-center">
          <!-- Điểm đi -->
          <div class="text-center me-3">
            <div class="fw-bold">{{route.depart_airport.code}}</div>
            <div class="text-muted small">{{route.depart_airport}}</div>
          </div>

          <!-- Icon máy bay -->
          <div class="me-3">
            <i class="fa-solid fa-plane"></i>
            <div class="dotted-underline"></div>
          </div>

          <!-- Điểm đến -->
          <div class="text-center">
            <div class="fw-bold">{{route.arrive_airport.code}}</div>
            <div class="text-muted small">{{route.arrive_airport}}</div>
          </div>
        </div>

        <!-- Ngày giờ chuyến đi -->
        <div class="text-end">
          <div class="fw-bold">Flights</div>
          <div class="text-muted">{{depart_date.strftime('%d/%m/%Y')}}</div>
        </div>
      </div>
    </div>

  <div class="result-flights">
    {% for item in flights.items %}
      <div class="card my-4 shadow-sm overflow-hidden">
        <div class="row g-0">
          <div class="col-md-4 text-center p-2">
            <div
              class="w-100 h-100 d-flex align-items-center justify-content-between"
            >
              <div class="d-flex flex-column align-items-center">
                <p class="mb-2">{{item.depart_time.strftime("%H:%M")}}</p>
                <p class="mb-2" title="{{route.depart_airport}}">
                  {{route.depart_airport.code}}
                </p>
                <p>{{item.depart_time.strftime("%d/%m/%Y")}}</p>
              </div>
              <div class="d-flex align-items-center flex-grow-1">
                <div class="dotted-underline"></div>
                <!--  -->
                <!--  -->
                {% if not item.intermediate_airports %}
                <small>nonstop</small>
                {% elif item.intermediate_airports |length == 1 %}
                <small title="{{item.intermediate_airports[0].airport}}"
                  >{{item.intermediate_airports[0].airport.code}}</small
                >
                {% else %}
                <small>{{item.intermediate_airports |length}} stops</small>
                {% endif %}
                <!--  -->
                <!--  -->
                <div class="dotted-underline"></div>
              </div>

              <div class="d-flex flex-column align-items-center">
                <p class="mb-2">{{item.arrive_time.strftime('%H:%M')}}</p>
                <p class="mb-2" title="{{route.arrive_airport}}">
                  {{route.arrive_airport.code}}
                </p>
                <p>{{item.arrive_time.strftime("%d/%m/%Y")}}</p>
              </div>
            </div>
          </div>
          <!--  -->
          <!--  -->
          <!--  -->
          <div class="col-md-4 border-start border-end p-2">
            <div class="mx-auto" style="width: fit-content">
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-clock me-1"></i>
                <span
                  >Flight duration: {{(item.arrive_time -
                  item.depart_time)}}</span
                >
              </div>
              <div >
                <div>Flight ID: {{item.id}}</div>
                <div>Airline: {{item.aircraft.airline.name}}</div>
                <div>Aircraft: {{item.aircraft.name}}</div>
                <a href="{{url_for('flights.showFlight', id=item.id)}}">Flight details</a>
              </div>
            </div>
          </div>
          <!--  -->
          <!--  -->
          <!--  -->
          <div class="col-md-4 d-flex flex-wrap">
            <!-- color for seat classes -->
            {% set colors = ['white', '#e0a623', '#223a60', '#C96868', '#118B50', '#FF7F3E'] %}
            <!-- users role -->
            {% set role = current_user.role.__str__() %} 
            <!--  -->
            {% set remain_time_to_depart = (item.depart_time - search_time).total_seconds()/60 %}
            <!-- If the the flight has departed -->
            {% if remain_time_to_depart <= 0 %}
              <div class="d-flex flex-column justify-content-center w-100">
                <div class="text-center">
                  <i class="fa-regular fa-paper-plane"></i>
                  <p class="text-muted">This flight has departed</p>
                </div>
              </div>
            <!-- If the staff cant even book -->
            {% elif remain_time_to_depart < staff_min_booking_time%}
              <div class="d-flex flex-column justify-content-center w-100">
                <div class="text-center">
                  <i class="fa-regular fa-circle-xmark"></i>
                  <p class="text-muted">
                    This flight doesn't allow to book anymore!
                  </p>
                </div>
              </div>
            <!-- If the user is a customer -->
            {% elif (not role or role == 'User') and remain_time_to_depart < customer_min_booking_time %} 
              <div class="d-flex flex-column justify-content-center w-100">
                <div class="text-center">
                  <i class="fa-solid fa-person-running"></i>
                  <p class="text-muted">Please go to the closest store to book!</p>
                </div>
              </div>
            <!--  -->
            {% else %}
              {% for id, class in item.get_seatclasses_and_info().items() %}
                {% if class['remaining'] > 0 %}
                  <a href="#" 
                  class="flex-grow-1 d-flex flex-column align-items-center text-white text-decoration-none" 
                  style="background-color: {{colors[id]}};"
                  >
                    <div class="mb-2">{{class['class_name']}}</div>
                    <div class="mb-2">{{class['price']}} {{class['currency']}}</div>
                    <div>Remaining: {{class['remaining']}}</div>
                  </a>
                {% else %}
                  <div class="flex-grow-1 d-block text-center bg-secondary">
                    <div>{{class['class_name']}}</div>
                    <div>Full</div>
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <!-- Thông báo khi không có chuyến bay -->
    <div class="alert alert-warning text-center mt-5">
      Không tìm thấy chuyến bay nào phù hợp. Vui lòng thử thay đổi bộ lọc hoặc
      thông tin tìm kiếm.
    </div>
  {% endif %}
  <!--  -->
  <!--  -->
  <!--  -->
  <!--  -->
  <!--  -->
  <!--  -->
  {% if flights %}
    <ul class="pagination">
      <!-- ======== Previous button ========-->
      {% if flights.page > 1 %}
        <li class="page-item">
          <a
          class="page-link"
          href="{{ url_for('flights.searchFlights', page=flights.page-1, from=route.depart_airport_id, to=route.arrive_airport_id, depart=depart_date) }}"
          >Previous</a
            >
          </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#">Previous</a>
        </li>
      {% endif %}
      <!-- ======== End Previous button ========-->
        
      <!-- ======== Page button ========-->
      {% for page_num in flights.iter_pages(left_edge=3, right_edge=3, left_current=3, right_current=3) %}
        {% if page_num %}
          <li class="page-item {% if flights.page == page_num %}active{% endif %}">
            <a
              class="page-link"
              href="{{ url_for('flights.searchFlights', page=page_num, from=route.depart_airport_id, to=route.arrive_airport_id, depart=depart_date) }}"
              >{{ page_num }}</a
            >
          </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#" >...</a>
        </li>
        {% endif %}
      {% endfor %}
      <!-- ======== End Page button ========-->

      <!-- ======== Next button ========-->
      {% if flights.page < flights.pages %}
        <li class="page-item">
          <a
          class="page-link"
          href="{{ url_for('flights.searchFlights', page=flights.page+1, from=route.depart_airport_id, to=route.arrive_airport_id, depart=depart_date) }}"
          >Next</a>
          </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#">Next</a>
        </li>
      {% endif %}
    <!-- ======== End Previous button ========-->
    </ul>
{% endif %}
</div>

{% endblock content %} {% block scripts %}
<script src="{{ url_for('static', filename='js/searchBox.js') }}"></script>
{% endblock %}
